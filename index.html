<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:fb="https://www.facebook.com/2008/fbml">
    <head>
	    <meta charset="utf-8">
        <title>MyBlog.com - The page for sharing</title>
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <meta name="description" content="	">
	    <meta name="author" content="M&S Worldwide">
        <link rel="stylesheet" media="screen" href="public/css/main.css">
        <link rel="shortcut icon" type="image/png" href="public/img/favicon.png">
	    <link href="public/css/bootstrap.css"  rel="stylesheet">
	    <style type="text/css">
	      body {
	        padding-top: 60px;
	        padding-bottom: 40px;
	      }
	    </style>
	    <link href="public/css/bootstrap-responsive.css" rel="stylesheet">

	    <!-- Le HTML5 shim, for IE6-8 support of HTML5 elements -->
	    <!--[if lt IE 9]>
	      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
	    <![endif]-->

	    <!-- Le fav and touch icons -->
	    <link rel="shortcut icon" href="../assets/ico/favicon.ico">
       	<script src="public/js/jquery/jquery-1.7.1.min.js" type="text/javascript"></script>
      	<script src="public/js/angularjs/angular.js"  type="text/javascript"></script> 
      	<script src="public/js/angularjs/angular-resource.js" type="text/javascript"></script>
        <script src="public/js/angularjs/angular-cookies.js" type="text/javascript"></script>

        <script src='http://connect.facebook.net/en_US/all.js'></script>
    </head>
    <body>
        <div id='fb-root'></div>
    	<div class="navbar navbar-fixed-top">
    		<div class="navbar-inner">
    	    	<div class="container">
   		      		<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
    	        		<span class="icon-bar"></span>
    	        		<span class="icon-bar"></span>
    	        		<span class="icon-bar"></span>
    	      		</a>
    	      		<a class="brand" href="#">MyBlog.com</a>
    	      		<div class="nav-collapse">
    	     			<ul class="nav">
    	      				<li class="active"><a href="#">Home</a></li>
    	         			<li><a href="#">About</a></li>
    	         			<li><a href="#">News</a></li>
    	         			<li><a href="#">Articles</a></li>
   		 	 				<li><a href="#">Contact</a></li>
   		 	 	 		</ul>
   		 	   			
   		 	   		</div> <!-- nav collapse -->
   				</div>  <!-- container -->
		</div>   <!-- navbar inner -->
	</div>   <!-- navbar -->
	<div class="container" >
       		<h3>What Is Angular?</h3>
       		<p>
AngularJS is a structural framework for dynamic web apps. 
It lets you use HTML as your template language and lets you extend HTML's syntax to 
express your application's components clearly and succinctly. Out of the box, 
it eliminates much of the code you currently write through data binding and dependency injection. 
And it all happens in JavaScript within the browser making it an ideal partner with any server technology.
			</p>
			<p>
Angular is what HTML would have been had it been designed for applications. 
HTML is a great declarative language for static documents. It does not contain much in the way of 
creating applications, and as a result building web applications is an exercise in what do I 
have to do, so that I trick the browser in to doing what I want.
            </p>

            <!-- From https://developers.facebook.com/docs/reference/dialogs/feed/ -->
            <!-- TODO - Add in login functionality from https://developers.facebook.com/docs/howtos/login/getting-started/ -->

        <p><a onclick='postToFeed(); return false;'>Post to Feed</a></p>
        <p id='msg'></p>

        <script>
            FB.init({appId: "518644834829463", status: true, cookie: true});

            function postToFeed() {

                // Get the ShareID from loyally.com

                // Based on http://www.w3schools.com/ajax/ajax_xmlhttprequest_onreadystatechange.asp
                // and http://www.w3schools.com/ajax/tryit.asp?filename=tryajax_first
                console.log("Start of postToFeed()");

                var shareID;
                var xmlhttp;
                if (window.XMLHttpRequest)
                {// code for IE7+, Firefox, Chrome, Opera, Safari
                    console.log("Setting up XMLHttpRequest()")
                    xmlhttp=new XMLHttpRequest();
                }

                // Removed code for IE5/6
                console.log("About to call xmlhttp.onreadystatechange()")
                xmlhttp.onreadystatechange=function()
                {
                    console.log("Now checking for xmlhttp.readyState==4 and xmlhttp.status=200");
                    //console.log("readystate = " + xmlhttp.readyState + " and status = " + xmlhttp.status);
                    if (xmlhttp.readyState==4 && xmlhttp.status==200)
                    {
                        console.log("readystate=4 and status=200!!")
                        // Get the shareID value from the Json response
                        // See http://stackoverflow.com/questions/4935632/how-to-parse-json-in-javascript
                        var jsonResponse=JSON.parse(xmlhttp.responseText),
                                shareID = jsonResponse.shareID;
                        console.log("Returned shareID from Json = " + shareID);
                        //shareID=xmlhttp.responseText;
                        var obj = {
                            method: 'feed',
                            redirect_uri: 'http://loyally.local/~markstrefford/myblog.com/thankyou.html',
                            link: 'http://loyally.local/~markstrefford/myblog.com/index.html?shareID=' + shareID,
                            picture: 'http://fbrell.com/f8.jpg',
                            name: 'AngularJS',
                            caption: 'What is angular JS',
                            description: 'Lets see if we can post from JS to FB with some loyally thrown in for good measure!'
                        };

                        function callback(response) {
                            document.getElementById('msg').innerHTML = "Post ID: " + response['post_id'];
                        }

                        FB.ui(obj, callback);
                    }
                }

                xmlhttp.open("POST", "http://loyally.local:9000/api/v01/share/register_url");
                xmlhttp.setRequestHeader("Content-Type", "application/json");
                xmlhttp.send(JSON.stringify({"url" : "http://myblog.com/2",
                                            "facebook_id" : "711041406",
                                            "scheme" : "111"}));
            }

            // When a page of this site loads, we want to see if there is a ?shareID=nnnnn value and post this back to loyally
            //
            // From http://stackoverflow.com/questions/65434/getting-notified-when-the-page-dom-has-loaded-but-before-window-onload

            function loadPageVar (sVar) {
                return unescape(window.location.search.replace(new RegExp("^(?:.*[&\\?]" + escape(sVar).replace(/[\.\+\*]/g, "\\$&") + "(?:\\=([^&]*))?)?.*$", "i"), "$1"));
            }

            $(document).ready ( function() {
                console.log("Page loaded - Checking if this is some loyally activity!!");
                var url = window.location.href;
                console.log("Current page URL is " + url);

                // From https://developer.mozilla.org/en-US/docs/DOM/window.location#Location%5Fobject
                //var oGetVars = {};

                if (window.location.search.length > 1) {
                    // Probably use this later to keep all other search values in URL
                    //for (var aItKey, nKeyId = 0, aCouples = window.location.search.substr(1).split("&"); nKeyId < aCouples.length; nKeyId++) {
                    //    aItKey = aCouples[nKeyId].split("=");
                    //    oGetVars[unescape(aItKey[0])] = aItKey.length > 1 ? unescape(aItKey[1]) : "";
                    //}
                    var shareID = loadPageVar("shareID");
                    console.log("Found shareID : " + shareID);
                } else {
                    console.log("No shareID specified on this page");
                }

                //console.log("Found shareID : " + oGetVars.shareID);

                // Now remove shareID from URL and redirect just to main URL
                // http://www.w3schools.com/js/js_window_location.asp
                // TODO - This currently removes all parameters after the "?" so needs to work better!!!
                if (shareID != null) {
                    var locationend = url.indexOf('?');
                    var new_url = url.substr(0, locationend);

                    // Fire off the loyally webservice call here!!!
                    var xmlhttpget;
                    if (window.XMLHttpRequest)
                    {// code for IE7+, Firefox, Chrome, Opera, Safari
                        console.log("Activity: Setting up XMLHttpRequest()")
                        xmlhttpget=new XMLHttpRequest();
                    }

                    // Removed code for IE5/6
                    console.log("About to call xmlhttp.onreadystatechange() for Activity")
                    xmlhttpget.onreadystatechange=function() {
                        console.log("Now checking for xmlhttp.readyState==4 and xmlhttp.status=200");

                        if (xmlhttpget.readyState==4 && xmlhttpget.status==200) {
                            console.log("readystate=4 and status=200!!");
                            console.log("So activity recorded!!");
                        }
                    }

                    console.log("About to do a GET to http://loyally.local:9000/api/v01/share/activity/" + shareID);
                    xmlhttpget.open("GET", "http://loyally.local:9000/api/v01/share/activity/" + shareID, true);
                    xmlhttpget.send();
                    console.log("Done our GET to http://loyally.local:9000/api/v01/share/activity/" + shareID);


                    console.log("Activity: Redirecting to " + new_url);
                    window.location.assign(new_url);

                }

            })
        </script>

            <hr />
      		<footer>
        		<p>&copy; M & S Worldwide 2012</p>
      		</footer>
   	</div> <!-- /container -->	
    </body>
</html>